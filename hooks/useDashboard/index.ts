import { useState, useEffect, useCallback } from 'react'
import { useDataLoader } from './useDataLoader'
import { useStatUpdater } from './useStatUpdater'
import { useCalculatedStats } from './useCalculatedStats'
import { generateRandomExperience } from '@/lib/types/dashboard'
import { ExperienceCalculatorService } from '@/lib/services/experience-calculator.service'
import { Stat } from '@/lib/types/dashboard'
import type { UseDashboardReturn } from './types'
import type { UserProfile } from '@/lib/database/types'

export function useDashboard(): UseDashboardReturn {
  const [stats, setStats] = useState<Stat[]>([])
  const [profile, setProfile] = useState<UserProfile | null>(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [processingStats, setProcessingStats] = useState<Set<string>>(new Set())

  // ë¶„ë¦¬ëœ í›…ë“¤ ì‚¬ìš©
  const { loadUserData } = useDataLoader(setStats, setLoading, setError, setProfile)
  const { updateStat } = useStatUpdater(stats, setStats, processingStats, setProcessingStats)
  const calculatedStats = useCalculatedStats(stats)

  // ì´ˆê¸° ë¡œë“œ
  useEffect(() => {
    loadUserData()
  }, []) // ì˜ë„ì ìœ¼ë¡œ ì˜ì¡´ì„± ë°°ì—´ ë¹„ì›€

  // ìŠ¤íƒ¯ í´ë¦­ í•¸ë“¤ëŸ¬
  const handleStatClick = useCallback(async(statType: string) => {
    const factors = ExperienceCalculatorService.calculateExperience(statType, 'ì§ì ‘ í™œë™')
    console.log('ğŸ“Š ê²½í—˜ì¹˜ ê³„ì‚°:', factors)
    await updateStat(statType, factors.finalExp, 'ì§ì ‘ í™œë™')
  }, [updateStat])

  // ìŒì„± ì…ë ¥ í•¸ë“¤ëŸ¬
  const handleVoiceInput = useCallback(async(transcript: string, activityType?: string | null) => {
    // activityTypeì´ ì§ì ‘ ì „ë‹¬ëœ ê²½ìš° (ìŠ¤íƒ¯ ì„ íƒ í›„ ë…¹ìŒ)
    if (activityType) {
      const factors = ExperienceCalculatorService.calculateExperience(activityType, transcript)
      console.log('ğŸ¤ Voice input experience:', factors)
      await updateStat(activityType, factors.finalExp, transcript)
      return
    }

    // activityTypeì´ ì—†ëŠ” ê²½ìš° í‚¤ì›Œë“œ ë§¤ì¹­ (ë ˆê±°ì‹œ ì§€ì›)
    const lowerTranscript = transcript.toLowerCase()
    const statTypeMap: Record<string, string> = {
      'ê±´ê°•': 'health',
      'í•™ìŠµ': 'learning',
      'ê´€ê³„': 'relationship',
      'ì„±ì·¨': 'achievement'
    }

    // ë§¤ì¹­ë˜ëŠ” ìŠ¤íƒ¯ ì°¾ê¸°
    for (const [korean, english] of Object.entries(statTypeMap)) {
      if (lowerTranscript.includes(korean)) {
        const factors = ExperienceCalculatorService.calculateExperience(english, transcript)
        console.log('ğŸ¤ Voice keyword match experience:', factors)
        await updateStat(english, factors.finalExp, transcript)
        return
      }
    }

    console.log('No matching stat type found in:', transcript)
  }, [updateStat])

  // ìŠ¤íƒ¯ ì•¡ì…˜ í•¸ë“¤ëŸ¬
  const handleStatAction = useCallback(async(statType: string, action: string) => {
    const factors = ExperienceCalculatorService.calculateExperience(statType, action)
    console.log('ğŸ“Š Action experience:', factors)
    await updateStat(statType, factors.finalExp, action)
  }, [updateStat])

  return {
    // State
    stats,
    profile,
    loading,
    error,
    isProcessing: processingStats,

    // Actions
    loadUserData,
    handleStatClick,
    handleVoiceInput,
    handleStatAction,
    retry: loadUserData,
    updateStat,

    // Computed
    calculatedStats
  }
}
